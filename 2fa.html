<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alternative Verification | Dimple</title>
    <meta
      name="description"
      content="Complete alternative verification to access your Dimple account"
    />
    <meta name="theme-color" content="#6c5ce7" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #6c5ce7;
        --primary-dark: #5649c0;
        --primary-light: #a29bfe;
        --secondary: #00cec9;
        --accent: #fd79a8;
        --text: #2d3436;
        --light: #f5f6fa;
        --error: #d63031;
        --success: #00b894;
        --warning: #fdcb6e;
        --referral: #ffeaa7;
        --bg-gradient: linear-gradient(135deg, #6c5ce7 0%, #00cec9 100%);
        --shadow: 0 10px 30px rgba(108, 92, 231, 0.2);
        --shadow-sm: 0 4px 15px rgba(108, 92, 231, 0.15);
        --radius: 16px;
        --radius-sm: 8px;
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: var(--light);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        color: var(--text);
        line-height: 1.6;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .container {
        width: 100%;
        max-width: 480px;
        background: #fff;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 40px 30px;
        position: relative;
        overflow: hidden;
        animation: fadeInUp 0.6s ease-out;
        transform-style: preserve-3d;
        height: fit-content;
        z-index: 1;
      }

      .container::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0) 70%
        );
        transform: rotate(30deg);
        z-index: -1;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        position: relative;
        z-index: 1;
      }

      .logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 15px;
        background: var(--bg-gradient);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 28px;
        font-weight: 700;
        box-shadow: var(--shadow-sm);
        animation: bounceIn 0.8s;
      }

      h1 {
        font-size: 24px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 10px;
      }

      .subtitle {
        font-size: 14px;
        color: #666;
        margin-bottom: 20px;
      }

      /* Verification Steps */
      .verification-steps {
        margin-bottom: 30px;
        position: relative;
      }

      .step {
        display: none;
        animation: fadeIn 0.5s ease-out;
      }

      .step.active {
        display: block;
      }

      .step-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .step-title i {
        font-size: 20px;
      }

      /* Puzzle Styles */
      .puzzle-container {
        background: rgba(108, 92, 231, 0.05);
        border-radius: var(--radius-sm);
        padding: 20px;
        margin-bottom: 20px;
        border: 1px dashed var(--primary-light);
      }

      .puzzle-question {
        font-size: 16px;
        margin-bottom: 15px;
        font-weight: 500;
      }

      .puzzle-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      @media (max-width: 360px) {
        .puzzle-options {
          grid-template-columns: 1fr;
        }
      }

      .puzzle-option {
        padding: 12px;
        border: 2px solid #eee;
        border-radius: var(--radius-sm);
        background: white;
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
        font-weight: 500;
      }

      .puzzle-option:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
      }

      .puzzle-option.selected {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .puzzle-option.correct {
        background: var(--success);
        color: white;
        border-color: var(--success);
      }

      .puzzle-option.wrong {
        background: var(--error);
        color: white;
        border-color: var(--error);
      }

      /* Math Puzzle */
      .math-puzzle {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: var(--radius-sm);
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
      }

      .math-equation {
        font-size: 24px;
        font-weight: 700;
        margin: 15px 0;
        color: var(--primary);
      }

      .math-answer {
        width: 100%;
        padding: 15px;
        border: 2px solid #eee;
        border-radius: var(--radius-sm);
        font-size: 16px;
        text-align: center;
        margin-bottom: 10px;
        transition: var(--transition);
      }

      .math-answer:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
      }

      /* Pattern Puzzle */
      .pattern-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 20px;
      }

      .pattern-cell {
        aspect-ratio: 1;
        background: white;
        border: 2px solid #eee;
        border-radius: var(--radius-sm);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        font-weight: 700;
        cursor: pointer;
        transition: var(--transition);
      }

      .pattern-cell:hover {
        transform: scale(1.05);
      }

      .pattern-cell.selected {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      /* PIN Setup */
      .pin-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 30px 0;
      }

      .pin-input {
        width: 50px;
        height: 60px;
        text-align: center;
        font-size: 24px;
        font-weight: 600;
        border: 2px solid #eee;
        border-radius: var(--radius-sm);
        background-color: #f9f9f9;
        transition: var(--transition);
        outline: none;
      }

      .pin-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        background-color: white;
      }

      .pin-input.error {
        border-color: var(--error);
      }

      /* Community Section */
      .community-section {
        background: rgba(0, 206, 201, 0.1);
        border-radius: var(--radius-sm);
        padding: 20px;
        margin-top: 30px;
        text-align: center;
        border: 1px dashed var(--secondary);
      }

      .community-icon {
        font-size: 32px;
        color: var(--secondary);
        margin-bottom: 10px;
      }

      .community-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--text);
      }

      .community-text {
        font-size: 14px;
        color: #666;
        margin-bottom: 15px;
      }

      .community-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: var(--secondary);
        color: white;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 600;
        transition: var(--transition);
      }

      .community-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 206, 201, 0.3);
      }

      /* Navigation */
      .step-nav {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
      }

      .btn {
        padding: 12px 20px;
        border: none;
        border-radius: var(--radius-sm);
        background: var(--bg-gradient);
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
      }

      .btn:active:not(:disabled) {
        transform: translateY(0);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        opacity: 0.7;
      }

      .btn-outline {
        background: white;
        color: var(--primary);
        border: 2px solid var(--primary);
      }

      .btn-outline:hover:not(:disabled) {
        background: rgba(108, 92, 231, 0.1);
      }

      /* Messages */
      .error-message {
        color: var(--error);
        font-size: 13px;
        margin-top: 5px;
        text-align: center;
        display: none;
      }

      .success-message {
        color: var(--success);
        font-size: 13px;
        margin-top: 5px;
        text-align: center;
        display: none;
      }

      /* Progress Bar */
      .progress-container {
        width: 100%;
        height: 6px;
        background: #eee;
        border-radius: 3px;
        margin-bottom: 30px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: var(--bg-gradient);
        border-radius: 3px;
        transition: width 0.5s ease;
      }

      /* Animations */
      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0px);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes bounceIn {
        0% {
          opacity: 0;
          transform: scale(0.3);
        }
        50% {
          opacity: 1;
          transform: scale(1.05);
        }
        70% {
          transform: scale(0.9);
        }
        100% {
          transform: scale(1);
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-5px);
        }
        20%,
        40%,
        60%,
        80% {
          transform: translateX(5px);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes confetti {
        0% {
          transform: translateY(0) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }

      .shake {
        animation: shake 0.5s;
      }

      /* Decorative Elements */
      .decoration {
        position: absolute;
        border-radius: 50%;
        background: rgba(108, 92, 231, 0.1);
        z-index: 0;
      }

      .decoration-1 {
        width: 120px;
        height: 120px;
        top: -50px;
        right: -50px;
        animation: float 8s ease-in-out infinite;
      }

      .decoration-2 {
        width: 80px;
        height: 80px;
        bottom: 30px;
        left: -30px;
        animation: float 8s ease-in-out infinite 1s;
      }

      .decoration-3 {
        width: 40px;
        height: 40px;
        bottom: 100px;
        right: 30px;
        animation: float 8s ease-in-out infinite 2s;
      }

      /* Confetti */
      .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        background: var(--primary);
        opacity: 0;
        z-index: 1000;
        animation: confetti 3s ease-out forwards;
      }

      /* Responsive adjustments */
      @media (max-width: 480px) {
        .container {
          padding: 30px 20px;
          border-radius: 12px;
        }

        h1 {
          font-size: 22px;
        }

        .pin-input {
          width: 45px;
          height: 55px;
          font-size: 22px;
        }

        .btn {
          padding: 12px 16px;
        }
      }

      @media (max-width: 360px) {
        .container {
          padding: 25px 15px;
        }

        .logo {
          width: 70px;
          height: 70px;
          font-size: 24px;
        }

        h1 {
          font-size: 20px;
        }

        .pin-input {
          width: 40px;
          height: 50px;
          font-size: 20px;
        }

        .btn {
          padding: 10px 14px;
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="decoration decoration-1"></div>
      <div class="decoration decoration-2"></div>
      <div class="decoration decoration-3"></div>

      <div class="header">
        <div class="logo">D</div>
        <h1 class="animate__animated animate__fadeIn">
          Alternative Verification
        </h1>
        <p class="subtitle animate__animated animate__fadeIn animate__delay-1s">
          Complete these steps to verify your account
        </p>
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="progressBar" style="width: 25%"></div>
      </div>

      <div class="verification-steps">
        <!-- Step 1: Choose Puzzle Type -->
        <div class="step active" id="step1">
          <h3 class="step-title">
            <i class="fas fa-puzzle-piece"></i> Choose Verification Method
          </h3>
          <p>Please select how you'd like to verify your identity:</p>

          <div class="puzzle-container">
            <div class="puzzle-option selected" data-type="math">
              <i class="fas fa-calculator"></i> Math Puzzle
            </div>
            <div class="puzzle-option" data-type="pattern">
              <i class="fas fa-th-large"></i> Pattern Recognition
            </div>
            <div class="puzzle-option" data-type="knowledge">
              <i class="fas fa-lightbulb"></i> Knowledge Quiz
            </div>
          </div>

          <div class="step-nav">
            <button class="btn" id="nextStep1">
              Continue <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 2: Math Puzzle -->
        <div class="step" id="step2-math">
          <h3 class="step-title">
            <i class="fas fa-calculator"></i> Solve the Math Puzzle
          </h3>
          <p>Solve this simple equation to prove you're human:</p>

          <div class="math-puzzle">
            <p class="puzzle-question">
              What is the solution to this equation?
            </p>
            <div class="math-equation" id="mathEquation">7 + 3 × 2 = ?</div>
            <input
              type="number"
              class="math-answer"
              id="mathAnswer"
              placeholder="Your answer"
            />
            <div class="error-message" id="mathError">
              Incorrect answer. Please try again.
            </div>
          </div>

          <div class="step-nav">
            <button class="btn btn-outline" id="backStep2Math">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <button class="btn" id="verifyMath">
              Verify <i class="fas fa-check"></i>
            </button>
          </div>
        </div>

        <!-- Step 2: Pattern Puzzle -->
        <div class="step" id="step2-pattern">
          <h3 class="step-title">
            <i class="fas fa-th-large"></i> Complete the Pattern
          </h3>
          <p>Select the correct shape to complete the sequence:</p>

          <div class="puzzle-container">
            <div class="pattern-grid">
              <div class="pattern-cell">1</div>
              <div class="pattern-cell">2</div>
              <div class="pattern-cell">3</div>
              <div class="pattern-cell">4</div>
              <div class="pattern-cell">?</div>
              <div class="pattern-cell">6</div>
              <div class="pattern-cell">7</div>
              <div class="pattern-cell">8</div>
              <div class="pattern-cell">9</div>
            </div>
            <p>What number should replace the question mark?</p>
            <div class="error-message" id="patternError">
              Incorrect pattern. Please try again.
            </div>
          </div>

          <div class="step-nav">
            <button class="btn btn-outline" id="backStep2Pattern">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <button class="btn" id="verifyPattern">
              Verify <i class="fas fa-check"></i>
            </button>
          </div>
        </div>

        <!-- Step 2: Knowledge Quiz -->
        <div class="step" id="step2-knowledge">
          <h3 class="step-title">
            <i class="fas fa-lightbulb"></i> Answer the Question
          </h3>
          <p>Answer this simple question to verify your identity:</p>

          <div class="puzzle-container">
            <p class="puzzle-question">What is the capital of France?</p>
            <div class="puzzle-options">
              <div class="puzzle-option" data-answer="london">London</div>
              <div class="puzzle-option" data-answer="berlin">Berlin</div>
              <div class="puzzle-option" data-answer="paris">Paris</div>
              <div class="puzzle-option" data-answer="madrid">Madrid</div>
            </div>
            <div class="error-message" id="knowledgeError">
              Incorrect answer. Please try again.
            </div>
          </div>

          <div class="step-nav">
            <button class="btn btn-outline" id="backStep2Knowledge">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <button class="btn" id="verifyKnowledge">
              Verify <i class="fas fa-check"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Set PIN -->
        <div class="step" id="step3">
          <h3 class="step-title">
            <i class="fas fa-lock"></i> Set Your Security PIN
          </h3>
          <p>
            Create a 4-digit PIN that you'll use for transactions and login:
          </p>

          <div class="pin-container" id="pinInputs">
            <input
              type="password"
              class="pin-input"
              maxlength="1"
              data-index="0"
              inputmode="numeric"
              pattern="[0-9]*"
            />
            <input
              type="password"
              class="pin-input"
              maxlength="1"
              data-index="1"
              inputmode="numeric"
              pattern="[0-9]*"
            />
            <input
              type="password"
              class="pin-input"
              maxlength="1"
              data-index="2"
              inputmode="numeric"
              pattern="[0-9]*"
            />
            <input
              type="password"
              class="pin-input"
              maxlength="1"
              data-index="3"
              inputmode="numeric"
              pattern="[0-9]*"
            />
          </div>

          <div class="error-message" id="pinError">
            PIN must be 4 digits and not sequential (e.g., 1234)
          </div>

          <div class="step-nav">
            <button class="btn btn-outline" id="backStep3">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <button class="btn" id="setPinBtn" disabled>
              Complete Setup <i class="fas fa-check-circle"></i>
            </button>
          </div>
        </div>

        <!-- Step 4: Success -->
        <div class="step" id="step4">
          <div style="text-align: center; padding: 20px 0">
            <div
              style="
                width: 100px;
                height: 100px;
                background: var(--success);
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 0 auto 20px;
                animation: pulse 2s infinite;
              "
            >
              <i class="fas fa-check" style="color: white; font-size: 40px"></i>
            </div>
            <h3
              style="
                font-size: 22px;
                margin-bottom: 10px;
                color: var(--success);
              "
            >
              Verification Complete!
            </h3>
            <p style="margin-bottom: 20px">
              Your account has been successfully verified. Redirecting to your
              dashboard...
            </p>
            <div class="success-message" id="redirectMessage">
              <i class="fas fa-spinner fa-spin"></i> Preparing your account...
            </div>
          </div>
        </div>
      </div>

      <!-- Community Section -->
      <div
        class="community-section animate__animated animate__fadeIn animate__delay-2s"
      >
        <div class="community-icon">
          <i class="fab fa-telegram"></i>
        </div>
        <h3 class="community-title">Join Our Community</h3>
        <p class="community-text">
          Connect with other Dimple users, get support, and stay updated with
          the latest features.
        </p>
        <a href="https://t.me/memorymat" class="community-btn" target="_blank">
          <i class="fab fa-telegram"></i> Join Telegram Group
        </a>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
      // Trusted Types policy to prevent security warnings
      if (window.trustedTypes && window.trustedTypes.createPolicy) {
        window.trustedTypes.createPolicy("default", {
          createHTML: (string) => string,
          createScriptURL: (string) => string,
          createScript: (string) => string,
        });
      }

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCgOvIkDCcS3DFrt5f6Y7pYmjCoHIfDF9U",
        authDomain: "moniebase-b4b4d.firebaseapp.com",
        projectId: "moniebase-b4b4d",
        storageBucket: "moniebase-b4b4d.appspot.com",
        messagingSenderId: "1009678808253",
        appId: "1:1009678808253:android:ff94e94c52bad2db7973d4",
        databaseURL: "https://moniebase-b4b4d-default-rtdb.firebaseio.com/",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // DOM elements
      const progressBar = document.getElementById("progressBar");
      const steps = document.querySelectorAll(".step");
      const puzzleOptions = document.querySelectorAll(
        ".puzzle-option[data-type]"
      );
      const nextStep1Btn = document.getElementById("nextStep1");
      const backStep2MathBtn = document.getElementById("backStep2Math");
      const verifyMathBtn = document.getElementById("verifyMath");
      const mathAnswer = document.getElementById("mathAnswer");
      const mathError = document.getElementById("mathError");
      const backStep2PatternBtn = document.getElementById("backStep2Pattern");
      const verifyPatternBtn = document.getElementById("verifyPattern");
      const patternCells = document.querySelectorAll(".pattern-cell");
      const patternError = document.getElementById("patternError");
      const backStep2KnowledgeBtn =
        document.getElementById("backStep2Knowledge");
      const verifyKnowledgeBtn = document.getElementById("verifyKnowledge");
      const knowledgeOptions = document.querySelectorAll(
        ".puzzle-option[data-answer]"
      );
      const knowledgeError = document.getElementById("knowledgeError");
      const backStep3Btn = document.getElementById("backStep3");
      const setPinBtn = document.getElementById("setPinBtn");
      const pinInputs = document.querySelectorAll(".pin-input");
      const pinError = document.getElementById("pinError");
      const redirectMessage = document.getElementById("redirectMessage");

      // Get user data from session storage
      const pendingUserId = sessionStorage.getItem("pendingUserId");
      const pendingUserEmail = sessionStorage.getItem("pendingUserEmail");

      // Current step and selected puzzle type
      let currentStep = 1;
      let selectedPuzzleType = "math";
      let selectedPatternAnswer = null;
      let selectedKnowledgeAnswer = null;

      // Initialize the page
      function init() {
        // Select first puzzle option by default
        puzzleOptions[0].classList.add("selected");

        // Set up event listeners
        setupEventListeners();

        // Generate random math equation
        generateMathEquation();
      }

      // Set up all event listeners
      function setupEventListeners() {
        // Puzzle type selection
        puzzleOptions.forEach((option) => {
          option.addEventListener("click", () => {
            puzzleOptions.forEach((opt) => opt.classList.remove("selected"));
            option.classList.add("selected");
            selectedPuzzleType = option.dataset.type;
          });
        });

        // Step 1: Next button
        nextStep1Btn.addEventListener("click", goToStep2);

        // Step 2 Math: Back and Verify buttons
        backStep2MathBtn.addEventListener("click", () => goToStep(1));
        verifyMathBtn.addEventListener("click", verifyMathAnswer);

        // Step 2 Pattern: Back and Verify buttons
        backStep2PatternBtn.addEventListener("click", () => goToStep(1));
        verifyPatternBtn.addEventListener("click", verifyPatternAnswer);

        // Pattern cell selection
        patternCells.forEach((cell) => {
          if (cell.textContent === "?") return;

          cell.addEventListener("click", () => {
            patternCells.forEach((c) => c.classList.remove("selected"));
            cell.classList.add("selected");
            selectedPatternAnswer = cell.textContent;
          });
        });

        // Step 2 Knowledge: Back and Verify buttons
        backStep2KnowledgeBtn.addEventListener("click", () => goToStep(1));
        verifyKnowledgeBtn.addEventListener("click", verifyKnowledgeAnswer);

        // Knowledge option selection
        knowledgeOptions.forEach((option) => {
          option.addEventListener("click", () => {
            knowledgeOptions.forEach((opt) => opt.classList.remove("selected"));
            option.classList.add("selected");
            selectedKnowledgeAnswer = option.dataset.answer;
          });
        });

        // Step 3: Back and Set PIN buttons
        backStep3Btn.addEventListener("click", () => goToStep(2));
        setPinBtn.addEventListener("click", completeVerification);

        // PIN input handling
        pinInputs.forEach((input, index) => {
          // Handle input
          input.addEventListener("input", (e) => {
            const value = e.target.value;

            // Only allow numbers
            if (value && !/^\d+$/.test(value)) {
              e.target.value = "";
              return;
            }

            // Move to next input if current has value
            if (value && index < pinInputs.length - 1) {
              pinInputs[index + 1].focus();
            }

            // Check if all inputs are filled
            checkPINInputs();
          });

          // Handle backspace
          input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace" && !input.value && index > 0) {
              pinInputs[index - 1].focus();
            }
          });
        });
      }

      // Generate random math equation
      function generateMathEquation() {
        const operations = ["+", "-", "×", "+"];
        const operation =
          operations[Math.floor(Math.random() * operations.length)];
        let num1, num2, answer;

        switch (operation) {
          case "+":
            num1 = Math.floor(Math.random() * 10) + 1;
            num2 = Math.floor(Math.random() * 10) + 1;
            answer = num1 + num2;
            break;
          case "-":
            num1 = Math.floor(Math.random() * 10) + 1;
            num2 = Math.floor(Math.random() * num1) + 1;
            answer = num1 - num2;
            break;
          case "×":
            num1 = Math.floor(Math.random() * 5) + 1;
            num2 = Math.floor(Math.random() * 5) + 1;
            answer = num1 * num2;
            break;
          case "+": // Additional addition for variety
            num1 = Math.floor(Math.random() * 15) + 1;
            num2 = Math.floor(Math.random() * 15) + 1;
            answer = num1 + num2;
            break;
        }

        document.getElementById(
          "mathEquation"
        ).textContent = `${num1} ${operation} ${num2} = ?`;
        mathAnswer.dataset.correctAnswer = answer;
      }

      // Go to specific step
      function goToStep(step) {
        // Hide all steps
        steps.forEach((step) => step.classList.remove("active"));

        // Show the selected step
        if (step === 2) {
          document
            .getElementById(`step2-${selectedPuzzleType}`)
            .classList.add("active");
          currentStep = 2;
          updateProgressBar(50);
        } else if (step === 3) {
          document.getElementById("step3").classList.add("active");
          currentStep = 3;
          updateProgressBar(75);
          // Focus first PIN input
          setTimeout(() => pinInputs[0].focus(), 300);
        } else {
          document.getElementById(`step${step}`).classList.add("active");
          currentStep = step;
          updateProgressBar(step === 1 ? 25 : 50);
        }
      }

      // Go to step 2 based on selected puzzle type
      function goToStep2() {
        goToStep(2);
      }

      // Update progress bar
      function updateProgressBar(percent) {
        progressBar.style.width = `${percent}%`;
      }

      // Verify math answer
      function verifyMathAnswer() {
        const userAnswer = parseInt(mathAnswer.value);
        const correctAnswer = parseInt(mathAnswer.dataset.correctAnswer);

        if (isNaN(userAnswer)) {
          mathError.textContent = "Please enter a valid number";
          mathError.style.display = "block";
          mathAnswer.classList.add("shake", "error");
          setTimeout(() => mathAnswer.classList.remove("shake"), 500);
          return;
        }

        if (userAnswer !== correctAnswer) {
          mathError.textContent = "Incorrect answer. Please try again.";
          mathError.style.display = "block";
          mathAnswer.classList.add("shake", "error");
          setTimeout(() => mathAnswer.classList.remove("shake"), 500);
          return;
        }

        // Correct answer
        mathError.style.display = "none";
        mathAnswer.classList.remove("error");
        goToStep(3);
      }

      // Verify pattern answer
      function verifyPatternAnswer() {
        if (!selectedPatternAnswer) {
          patternError.textContent = "Please select a number";
          patternError.style.display = "block";
          return;
        }

        // Correct answer is 5 (middle of 1-9 grid)
        if (selectedPatternAnswer !== "5") {
          patternError.textContent = "Incorrect pattern. Please try again.";
          patternError.style.display = "block";
          patternCells.forEach((cell) => {
            if (cell.textContent === selectedPatternAnswer) {
              cell.classList.add("shake", "wrong");
              setTimeout(() => cell.classList.remove("shake"), 500);
            }
          });
          return;
        }

        // Correct answer
        patternError.style.display = "none";
        patternCells.forEach((cell) => {
          if (cell.textContent === selectedPatternAnswer) {
            cell.classList.add("correct");
          }
        });
        setTimeout(() => goToStep(3), 1000);
      }

      // Verify knowledge answer
      function verifyKnowledgeAnswer() {
        if (!selectedKnowledgeAnswer) {
          knowledgeError.textContent = "Please select an answer";
          knowledgeError.style.display = "block";
          return;
        }

        // Correct answer is Paris
        if (selectedKnowledgeAnswer !== "paris") {
          knowledgeError.textContent = "Incorrect answer. Please try again.";
          knowledgeError.style.display = "block";
          knowledgeOptions.forEach((option) => {
            if (option.dataset.answer === selectedKnowledgeAnswer) {
              option.classList.add("shake", "wrong");
              setTimeout(() => option.classList.remove("shake"), 500);
            }
          });
          return;
        }

        // Correct answer
        knowledgeError.style.display = "none";
        knowledgeOptions.forEach((option) => {
          if (option.dataset.answer === selectedKnowledgeAnswer) {
            option.classList.add("correct");
          }
        });
        setTimeout(() => goToStep(3), 1000);
      }

      // Check if all PIN inputs are filled
      function checkPINInputs() {
        const allFilled = Array.from(pinInputs).every(
          (input) => input.value.trim() !== ""
        );
        setPinBtn.disabled = !allFilled;
      }

      // Complete verification process
      async function completeVerification() {
        // Get PIN code
        const pinCode = Array.from(pinInputs)
          .map((input) => input.value)
          .join("");

        // Validate PIN (simple check for demo)
        if (pinCode.length !== 4) {
          pinError.textContent = "PIN must be 4 digits";
          pinError.style.display = "block";
          pinInputs.forEach((input) => input.classList.add("shake", "error"));
          setTimeout(
            () => pinInputs.forEach((input) => input.classList.remove("shake")),
            500
          );
          return;
        }

        // Check for simple PINs (for security)
        if (
          /(\d)\1{3}/.test(pinCode) || // All same digits
          "1234" === pinCode ||
          "4321" === pinCode || // Sequential
          "0000" === pinCode ||
          "1111" === pinCode
        ) {
          pinError.textContent = "Please choose a stronger PIN";
          pinError.style.display = "block";
          pinInputs.forEach((input) => input.classList.add("shake", "error"));
          setTimeout(
            () => pinInputs.forEach((input) => input.classList.remove("shake")),
            500
          );
          return;
        }

        // Show loading state
        setPinBtn.disabled = true;
        setPinBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Processing...';

        try {
          // Update user status in Firebase
          await database.ref("users/" + pendingUserId).update({
            status: "verified",
            pin: pinCode,
            verifiedAt: firebase.database.ServerValue.TIMESTAMP,
          });

          // Show success step
          goToStep(4);
          createConfetti();
          updateProgressBar(100);

          // Redirect to dashboard after delay
          setTimeout(() => {
            redirectMessage.innerHTML =
              '<i class="fas fa-check"></i> Redirecting to dashboard...';
            setTimeout(() => {
              window.location.href = "dashboard.html";
            }, 1500);
          }, 2000);
        } catch (error) {
          console.error("Error completing verification:", error);
          pinError.textContent = "An error occurred. Please try again.";
          pinError.style.display = "block";
          setPinBtn.disabled = false;
          setPinBtn.innerHTML =
            'Complete Setup <i class="fas fa-check-circle"></i>';
        }
      }

      // Create confetti effect
      function createConfetti() {
        const colors = ["#6c5ce7", "#00cec9", "#fd79a8", "#fdcb6e", "#00b894"];

        for (let i = 0; i < 100; i++) {
          const confetti = document.createElement("div");
          confetti.className = "confetti";
          confetti.style.background =
            colors[Math.floor(Math.random() * colors.length)];
          confetti.style.left = Math.random() * 100 + "vw";
          confetti.style.width = Math.random() * 10 + 5 + "px";
          confetti.style.height = Math.random() * 10 + 5 + "px";
          confetti.style.animationDuration = Math.random() * 2 + 2 + "s";
          confetti.style.animationDelay = Math.random() * 2 + "s";
          document.body.appendChild(confetti);

          // Remove confetti after animation
          setTimeout(() => {
            confetti.remove();
          }, 5000);
        }
      }

      // Initialize the page
      init();
    </script>
  </body>
</html>
